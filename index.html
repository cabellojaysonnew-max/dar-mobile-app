<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAR Mobile Portal</title>
    <style>
        /* --- CSS STYLES (Matches your Python DAR Theme) --- */
        :root {
            --dar-green: #003811;
            --dar-gold: #D4AF37;
            --bg-main: #F3F4F6;
            --text-main: #1F2937;
        }
        body { background-color: var(--bg-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; color: var(--text-main); }
        .container { max-width: 450px; margin: 0 auto; padding-bottom: 80px; }
        
        /* CARDS & INPUTS */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h2 { color: var(--dar-green); margin: 0 0 5px 0; font-size: 22px; font-weight: 800; text-align: center; }
        .sub-head { text-align: center; color: #666; font-size: 13px; margin-bottom: 20px; }
        
        label { font-size: 11px; font-weight: 700; color: #6B7280; text-transform: uppercase; display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        input:focus { outline: 2px solid var(--dar-green); border-color: var(--dar-green); }
        
        /* BUTTONS */
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--dar-green); color: white; }
        .btn-primary:active { transform: scale(0.98); background: #00290c; }
        .btn-logout { background: transparent; border: 1px solid #d1d5db; color: #666; width: auto; padding: 6px 12px; font-size: 12px; }
        .btn-add { background: var(--dar-gold); color: var(--dar-green); margin-bottom: 15px; }

        /* LISTS & BADGES */
        .hidden { display: none !important; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .status-APPROVED { background: #dcfce7; color: #15803d; }
        .status-PENDING { background: #ffedd5; color: #9a3412; }
        
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e5e7eb; display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 999; }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; font-size: 10px; color: #9ca3af; font-weight: 600; cursor: pointer; }
        .nav-item.active { color: var(--dar-green); background: #f9fafb; }
        .emoji { font-size: 20px; display: block; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div id="view-login" class="container" style="margin-top: 40px;">
        <div class="card">
            <h2>DAR TRAVEL</h2>
            <p class="sub-head">Secure Mobile Portal</p>
            <hr style="border:0; border-top:1px solid #eee; margin-bottom:20px;">
            
            <label>Employee ID</label>
            <input type="text" id="uid" placeholder="Enter ID">
            
            <label>Password</label>
            <input type="password" id="pwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            
            <button onclick="doLogin()" class="btn-primary" id="btn-login">SECURE LOGIN</button>
            <div id="login-msg" style="text-align:center; color:#ef4444; font-size:13px; margin-top:15px;"></div>
        </div>
        <div style="text-align:center; font-size:11px; color:#999;">Connection via Secure Relay</div>
    </div>

    <div id="view-app" class="container hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div>
                <h3 id="disp-name" style="margin:0; color:var(--dar-green);">User</h3>
                <span id="disp-div" style="font-size:12px; color:#666;">Division</span>
            </div>
            <button onclick="location.reload()" class="btn-logout">Exit</button>
        </div>

        <div id="page-post">
            <div class="card">
                <label>Transport</label>
                <select id="p-trans">
                    <option>LAND</option>
                    <option>GOV'T VEHICLE</option>
                    <option>AIR</option>
                    <option>OTHERS</option>
                </select>

                <label>Report To</label>
                <input type="text" id="p-report" placeholder="Official Name / Position">

                <hr style="border:0; border-top:1px dashed #ddd; margin: 15px 0;">
                
                <label>Itinerary Date</label>
                <input type="date" id="p-date">
                
                <label>Destination</label>
                <input type="text" id="p-dest">
                
                <label>Purpose</label>
                <input type="text" id="p-purp">

                <button onclick="submitOrder()" class="btn-primary">SUBMIT APPLICATION</button>
            </div>
        </div>

        <div id="page-hist" class="hidden">
            <button onclick="loadHistory()" class="btn-logout" style="width:100%; margin-bottom:15px; background:white;">Refresh List</button>
            <div id="hist-list"></div>
        </div>
    </div>

    <div id="navbar" class="nav hidden">
        <div class="nav-item active" onclick="nav('post', this)">
            <span class="emoji">‚úèÔ∏è</span>New Order
        </div>
        <div class="nav-item" onclick="nav('hist', this)">
            <span class="emoji">üìã</span>History
        </div>
    </div>

    <script>
        // --- CONFIGURATION FROM YOUR PYTHON SCRIPT ---
        const PROXY = "https://corsproxy.io/?"; // Solves the mobile blocking issue
        const DB_URL = "https://ytfpiyfapvybihlngxks.supabase.co/rest/v1";
        const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0ZnBpeWZhcHZ5YmlobG5neGtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDA2MTIsImV4cCI6MjA4NTY3NjYxMn0.7TRVjvFjxVtxkP_hL3wnlxPT6FXJd0y7aKHNzDHThAQ";
        
        let currentUser = null;

        // --- SECURE FETCH FUNCTION (Solves 'Failed to Fetch') ---
        async function api(endpoint, method = "GET", body = null) {
            const fullUrl = PROXY + encodeURIComponent(`${DB_URL}/${endpoint}`);
            
            const options = {
                method: method,
                headers: {
                    "apikey": KEY,
                    "Authorization": "Bearer " + KEY,
                    "Content-Type": "application/json",
                    "Prefer": "return=representation"
                }
            };
            if (body) options.body = JSON.stringify(body);

            try {
                const res = await fetch(fullUrl, options);
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                return await res.json();
            } catch (e) {
                console.error(e);
                throw new Error("Network Error. Please verify connection.");
            }
        }

        // --- 1. LOGIN LOGIC ---
        async function doLogin() {
            const uid = document.getElementById('uid').value.trim();
            const pwd = document.getElementById('pwd').value.trim();
            const btn = document.getElementById('btn-login');
            const msg = document.getElementById('login-msg');

            if (!uid || !pwd) { msg.innerText = "Please enter credentials"; return; }

            btn.innerText = "CONNECTING...";
            btn.disabled = true;
            msg.innerText = "";

            try {
                // Fetch user data
                const data = await api(`employees?emp_id=eq.${uid}&select=*`);
                
                if (!data || data.length === 0) throw new Error("User ID not found");
                const user = data[0];

                // Check Password (Basic check, works if Python didn't hash it yet)
                // If Python hashed it, we assume simple match for this mobile lite version
                // or you need to reset pass to plain text for this specific user to test.
                if (user.pass !== pwd) {
                     // Attempt basic check. If bcrypt was used in Python, 
                     // this mobile version needs a plain text password or a reset.
                     throw new Error("Incorrect Password");
                }

                // Success
                currentUser = user;
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                document.getElementById('navbar').classList.remove('hidden');
                
                document.getElementById('disp-name').innerText = user.full_name;
                document.getElementById('disp-div').innerText = user.division || "DAR";

            } catch (e) {
                msg.innerText = e.message;
                btn.innerText = "SECURE LOGIN";
                btn.disabled = false;
            }
        }

        // --- 2. SUBMIT LOGIC ---
        async function submitOrder() {
            const dest = document.getElementById('p-dest').value;
            const date = document.getElementById('p-date').value;
            const purp = document.getElementById('p-purp').value;
            const rep = document.getElementById('p-report').value;

            if (!dest || !date) { alert("Please fill Destination and Date"); return; }
            if (!confirm("Submit this Travel Order?")) return;

            const btn = document.querySelector('#page-post button');
            btn.innerText = "SENDING...";
            btn.disabled = true;

            try {
                // Generate TO Number
                const yr = "2026";
                const div = (currentUser.division || "DAR").substring(0,4).toUpperCase();
                
                // Get count to make ID
                const recent = await api(`travel_orders?to_no=ilike.${yr}-${div}-%&order=created_at.desc&limit=1`);
                let nextNum = 1;
                if (recent.length > 0) {
                    const parts = recent[0].to_no.split('-');
                    if (parts.length > 2) nextNum = parseInt(parts[2]) + 1;
                }
                const toNo = `${yr}-${div}-${String(nextNum).padStart(4,'0')}`;

                // Status Logic (Matches Python)
                let st = "PENDING_CHIEF";
                const u = (currentUser.unit || "").toUpperCase();
                if (u === "PARPO") st = "PENDING_PARPO";
                else if (u && u !== "NONE") st = "PENDING_UNIT_HEAD";

                // Post Order Header
                await api('travel_orders', 'POST', {
                    to_no: toNo, emp_id: currentUser.emp_id, emp_name: currentUser.full_name,
                    division: currentUser.division, unit: currentUser.unit, status: st,
                    transport: document.getElementById('p-trans').value, 
                    report_to: rep
                });

                // Post Itinerary
                await api('itinerary', 'POST', {
                    to_no: toNo, travel_date: date, destination: dest, purpose: purp
                });

                alert("Success! TO # " + toNo + " Submitted.");
                
                // Clear and Switch
                document.getElementById('p-dest').value = "";
                document.getElementById('p-purp').value = "";
                nav('hist', document.querySelectorAll('.nav-item')[1]);

            } catch (e) {
                alert("Error: " + e.message);
            }
            btn.innerText = "SUBMIT APPLICATION";
            btn.disabled = false;
        }

        // --- 3. HISTORY LOGIC ---
        async function loadHistory() {
            const list = document.getElementById('hist-list');
            list.innerHTML = "<p style='text-align:center;color:#999;margin-top:20px;'>Loading...</p>";

            try {
                const data = await api(`travel_orders?emp_id=eq.${currentUser.emp_id}&order=created_at.desc&limit=10`);
                
                list.innerHTML = "";
                if (data.length === 0) {
                    list.innerHTML = "<p style='text-align:center;color:#999;margin-top:20px;'>No Records Found</p>";
                    return;
                }

                data.forEach(item => {
                    // Simple badge logic
                    let statusClass = "status-PENDING";
                    if (item.status === 'APPROVED') statusClass = "status-APPROVED";
                    
                    list.innerHTML += `
                        <div class="card" style="padding:15px; margin-bottom:10px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <strong style="color:#111;">${item.to_no}</strong>
                                <span class="badge ${statusClass}">${item.status.replace('PENDING_', '')}</span>
                            </div>
                            <div style="font-size:12px; color:#666;">
                                Transport: ${item.transport}
                            </div>
                        </div>
                    `;
                });
            } catch (e) {
                list.innerHTML = "<p style='text-align:center;color:red;'>Failed to load history.</p>";
            }
        }

        // --- NAVIGATION ---
        function nav(page, el) {
            document.getElementById('page-post').classList.add('hidden');
            document.getElementById('page-hist').classList.add('hidden');
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            
            el.classList.add('active');
            
            if (page === 'post') document.getElementById('page-post').classList.remove('hidden');
            else {
                document.getElementById('page-hist').classList.remove('hidden');
                loadHistory();
            }
        }
    </script>
</body>
</html>
