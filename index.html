<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAR Travel Relay</title>
    <style>
        /* CLEAN MOBILE STYLES */
        body { background-color: #f4f4f5; font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 400px; margin: 0 auto; padding-bottom: 80px; }
        
        /* CARD DESIGN */
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 15px; }
        .header { text-align: center; margin-bottom: 25px; }
        .header h2 { margin: 0; color: #003811; font-size: 24px; letter-spacing: -0.5px; }
        .header p { margin: 5px 0 0 0; color: #666; font-size: 13px; }

        /* INPUTS */
        label { font-size: 11px; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 6px; }
        input { width: 100%; padding: 14px; margin-bottom: 16px; border: 1px solid #e1e1e1; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: #fafafa; transition: 0.2s; }
        input:focus { border-color: #003811; background: #fff; outline: none; }
        
        /* BUTTONS */
        button { width: 100%; padding: 16px; border: none; border-radius: 10px; font-size: 15px; font-weight: 700; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-primary { background: #003811; color: white; box-shadow: 0 4px 12px rgba(0, 56, 17, 0.2); }
        .btn-logout { background: #fff; border: 1px solid #ddd; color: #666; padding: 8px 15px; font-size: 12px; width: auto; }
        
        /* UTILS */
        .hidden { display: none !important; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }
        .approved { background: #dcfce7; color: #166534; }
        .pending { background: #ffedd5; color: #9a3412; }
        .status-bar { font-size: 11px; text-align: center; color: #999; margin-top: 20px; }

        /* NAV */
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee; display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 100; }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; color: #aaa; font-size: 10px; font-weight: 600; }
        .nav-item.active { color: #003811; background: #fcfcfc; }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div id="view-login" class="container" style="margin-top: 40px;">
        <div class="card">
            <div class="header">
                <h2>DAR TRAVEL</h2>
                <p>Secure Relay Connection</p>
            </div>
            
            <label>Employee ID</label>
            <input type="text" id="uid" placeholder="Enter ID (e.g. 1001)">
            
            <label>Password</label>
            <input type="password" id="pwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            
            <button onclick="doLogin()" class="btn-primary" id="btn-login">CONNECT SECURELY</button>
            <div id="login-msg" style="text-align:center; color:#dc2626; font-size:13px; margin-top:15px;"></div>
        </div>
        <div class="status-bar">v4.0 Relay ‚Ä¢ No VPN Required</div>
    </div>

    <div id="view-app" class="container hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding: 0 5px;">
            <div>
                <h3 id="u-name" style="margin:0; color:#003811;">User</h3>
                <span id="u-div" style="font-size:12px; color:#666;">Division</span>
            </div>
            <button onclick="location.reload()" class="btn-logout">Exit</button>
        </div>

        <div id="page-post">
            <div class="card">
                <div class="header" style="margin-bottom:15px; text-align:left;">
                    <h3 style="margin:0; font-size:18px;">New Travel Order</h3>
                </div>
                
                <label>Destination</label>
                <input type="text" id="p-dest">
                
                <label>Date of Travel</label>
                <input type="date" id="p-date">
                
                <label>Purpose</label>
                <input type="text" id="p-purp">
                
                <button onclick="submitOrder()" class="btn-primary">SUBMIT APPLICATION</button>
            </div>
        </div>

        <div id="page-hist" class="hidden">
            <button onclick="loadHistory()" class="btn-logout" style="width:100%; margin-bottom:15px;">Refresh List</button>
            <div id="hist-list"></div>
        </div>
    </div>

    <div id="navbar" class="nav hidden">
        <div class="nav-item active" onclick="nav('post', this)">
            <span class="nav-icon">‚úèÔ∏è</span>Apply
        </div>
        <div class="nav-item" onclick="nav('hist', this)">
            <span class="nav-icon">üìã</span>History
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // We route through 'corsproxy.io' to bypass your phone's blocking issues
        const PROXY = "https://corsproxy.io/?";
        const DB_URL = "https://ytfpiyfapvybihlngxks.supabase.co/rest/v1";
        const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0ZnBpeWZhcHZ5YmlobG5neGtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDA2MTIsImV4cCI6MjA4NTY3NjYxMn0.7TRVjvFjxVtxkP_hL3wnlxPT6FXJd0y7aKHNzDHThAQ";
        
        let currentUser = null;

        // --- THE "SILVER BULLET" FETCH FUNCTION ---
        async function secureFetch(endpoint, method = "GET", body = null) {
            // Construct the FULL URL with the Proxy
            // encodeURIComponent ensures the DB URL passes safely through the proxy
            const targetUrl = `${DB_URL}/${endpoint}`;
            const finalUrl = PROXY + encodeURIComponent(targetUrl);

            const options = {
                method: method,
                headers: {
                    "apikey": API_KEY,
                    "Authorization": "Bearer " + API_KEY,
                    "Content-Type": "application/json",
                    "Prefer": "return=representation"
                }
            };

            if (body) options.body = JSON.stringify(body);

            try {
                const res = await fetch(finalUrl, options);
                if (!res.ok) throw new Error(`Server Error: ${res.status}`);
                return await res.json();
            } catch (err) {
                console.error(err);
                throw new Error("Network Blocked. Switch to Data/WiFi.");
            }
        }

        // --- 1. LOGIN ---
        async function doLogin() {
            const uid = document.getElementById('uid').value.trim();
            const pwd = document.getElementById('pwd').value.trim();
            const btn = document.getElementById('btn-login');
            const msg = document.getElementById('login-msg');

            if (!uid || !pwd) { msg.innerText = "Please enter ID and Password"; return; }

            btn.innerText = "CONNECTING VIA RELAY...";
            btn.disabled = true;
            msg.innerText = "";

            try {
                // Fetch User via Proxy
                const data = await secureFetch(`employees?emp_id=eq.${uid}&select=*`);
                
                if (!data || data.length === 0) throw new Error("User ID not found");
                
                const user = data[0];
                
                // Simple Password Check
                if (user.pass !== pwd) throw new Error("Incorrect Password");

                // Success
                currentUser = user;
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                document.getElementById('navbar').classList.remove('hidden');
                
                document.getElementById('u-name').innerText = user.full_name;
                document.getElementById('u-div').innerText = user.division || "DAR";

            } catch (e) {
                msg.innerText = e.message;
                btn.innerText = "CONNECT SECURELY";
                btn.disabled = false;
            }
        }

        // --- 2. SUBMIT ---
        async function submitOrder() {
            const dest = document.getElementById('p-dest').value;
            const date = document.getElementById('p-date').value;
            const purp = document.getElementById('p-purp').value;

            if (!dest || !date) { alert("Please fill all fields"); return; }
            if (!confirm("Submit this Travel Order?")) return;

            const btn = document.querySelector('#page-post button');
            btn.innerText = "SENDING...";
            btn.disabled = true;

            try {
                // Generate TO Number Logic
                const yr = "2026";
                const div = (currentUser.division || "DAR").substring(0,4).toUpperCase();
                
                // Fetch latest to calculate number
                const recent = await secureFetch(`travel_orders?to_no=ilike.${yr}-${div}-%&order=created_at.desc&limit=1`);
                
                let nextNum = 1;
                if (recent.length > 0) {
                    const parts = recent[0].to_no.split('-');
                    if (parts.length > 2) nextNum = parseInt(parts[2]) + 1;
                }
                const toNo = `${yr}-${div}-${String(nextNum).padStart(4,'0')}`;

                // Determine Status
                let status = "PENDING_CHIEF";
                const u = (currentUser.unit || "").toUpperCase();
                if (u === "PARPO") status = "PENDING_PARPO";
                else if (u && u !== "NONE") status = "PENDING_UNIT_HEAD";

                // Post Order
                await secureFetch('travel_orders', 'POST', {
                    to_no: toNo,
                    emp_id: currentUser.emp_id,
                    emp_name: currentUser.full_name,
                    division: currentUser.division,
                    unit: currentUser.unit,
                    status: status,
                    transport: "LAND",
                    report_to: "Official"
                });

                // Post Itinerary
                await secureFetch('itinerary', 'POST', {
                    to_no: toNo,
                    travel_date: date,
                    destination: dest,
                    purpose: purp
                });

                alert("Success! TO # " + toNo);
                
                // Clear and switch
                document.getElementById('p-dest').value = "";
                document.getElementById('p-purp').value = "";
                nav('hist', document.querySelectorAll('.nav-item')[1]);

            } catch (e) {
                alert("Error: " + e.message);
            }
            btn.innerText = "SUBMIT APPLICATION";
            btn.disabled = false;
        }

        // --- 3. HISTORY ---
        async function loadHistory() {
            const list = document.getElementById('hist-list');
            list.innerHTML = "<p style='text-align:center;color:#999;margin-top:20px;'>Loading Records...</p>";

            try {
                const data = await secureFetch(`travel_orders?emp_id=eq.${currentUser.emp_id}&order=created_at.desc&limit=10`);
                
                list.innerHTML = "";
                if (data.length === 0) {
                    list.innerHTML = "<p style='text-align:center;color:#999;margin-top:20px;'>No History Found</p>";
                    return;
                }

                data.forEach(item => {
                    const badgeClass = item.status === 'APPROVED' ? 'approved' : 'pending';
                    list.innerHTML += `
                        <div class="card" style="padding:15px; margin-bottom:10px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <strong style="font-size:14px; color:#333;">${item.to_no}</strong>
                                <span class="badge ${badgeClass}">${item.status}</span>
                            </div>
                            <div style="font-size:12px; color:#666;">
                                Transport: ${item.transport || 'N/A'}
                            </div>
                        </div>
                    `;
                });
            } catch (e) {
                list.innerHTML = "<p style='text-align:center;color:red;'>Failed to load history.</p>";
            }
        }

        // --- NAV ---
        function nav(page, el) {
            document.getElementById('page-post').classList.add('hidden');
            document.getElementById('page-hist').classList.add('hidden');
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            
            el.classList.add('active');
            
            if (page === 'post') document.getElementById('page-post').classList.remove('hidden');
            else {
                document.getElementById('page-hist').classList.remove('hidden');
                loadHistory();
            }
        }
    </script>
</body>
</html>
