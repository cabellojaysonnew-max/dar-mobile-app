<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAR Mobile V3</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; padding: 20px; }
        .card { max-width: 400px; margin: 0 auto; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-dar { background-color: #003811; color: white; font-weight: bold; }
        .hidden { display: none !important; }
        #system-status { font-size: 11px; margin-top: 15px; text-align: center; padding: 10px; border-radius: 5px; background: #eee; }
    </style>
</head>
<body>

    <div id="view-login" class="container mt-4">
        <div class="card p-4">
            <h3 class="text-center" style="color:#003811; font-weight:bold">DAR TRAVEL</h3>
            <p class="text-center text-muted small">Mobile Portal V3</p>
            <hr>
            
            <div class="mb-3">
                <label class="form-label small fw-bold">ID Number</label>
                <input type="text" id="inp-id" class="form-control" placeholder="Enter ID">
            </div>
            
            <div class="mb-4">
                <label class="form-label small fw-bold">Password</label>
                <input type="password" id="inp-pass" class="form-control" placeholder="••••••">
            </div>

            <button id="btn-login" class="btn btn-dar w-100 py-2" disabled>WAITING FOR NETWORK...</button>
            
            <div id="system-status">⚡ Connecting to Cloud...</div>
            <button id="btn-retry" class="btn btn-sm btn-outline-secondary w-100 mt-2 hidden" onclick="window.location.reload()">⚠️ Reload Page</button>
        </div>
    </div>

    <div id="view-app" class="hidden">
        <nav class="navbar fixed-top" style="background:#003811; color:white">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1 text-warning">DAR Mobile</span>
                <button onclick="location.reload()" class="btn btn-sm btn-outline-light">Logout</button>
            </div>
        </nav>
        <div style="margin-top: 80px" class="container">
            <h5 class="mb-3">New Application</h5>
            <div class="card p-3 mb-3">
                <input type="text" id="app-dest" class="form-control mb-2" placeholder="Destination">
                <input type="date" id="app-date" class="form-control mb-2">
                <input type="text" id="app-purp" class="form-control mb-2" placeholder="Purpose">
                <button onclick="submitApp()" class="btn btn-success mt-2">Submit</button>
            </div>
            
            <h5 class="mb-3">My History</h5>
            <button onclick="loadHistory()" class="btn btn-sm btn-secondary mb-2">Refresh List</button>
            <div id="list-history">Loading...</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase/2.39.3/supabase.min.js" 
            onload="libLoaded('Supabase')" 
            onerror="libFailed('Supabase')"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"
            onload="libLoaded('Bcrypt')" 
            onerror="libFailed('Bcrypt')"></script>

    <script>
        // CONFIG
        const URL = "https://ytfpiyfapvybihlngxks.supabase.co";
        const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0ZnBpeWZhcHZ5YmlobG5neGtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDA2MTIsImV4cCI6MjA4NTY3NjYxMn0.7TRVjvFjxVtxkP_hL3wnlxPT6FXJd0y7aKHNzDHThAQ";
        
        let supabase = null;
        let libsReady = 0;
        const statusDiv = document.getElementById('system-status');
        const loginBtn = document.getElementById('btn-login');

        // TRACK LIBRARY LOADING
        function libLoaded(name) {
            console.log(name + " Loaded");
            libsReady++;
            if(libsReady === 2) {
                initApp();
            }
        }

        function libFailed(name) {
            statusDiv.innerHTML = `<span style="color:red">❌ Failed to load ${name}. Check Internet.</span>`;
            statusDiv.style.background = "#fee2e2";
            document.getElementById('btn-retry').classList.remove('hidden');
        }

        // INITIALIZE APP ONCE LIBS ARE READY
        function initApp() {
            try {
                if(window.supabase) {
                    supabase = window.supabase.createClient(URL, KEY);
                    statusDiv.innerHTML = `<span style="color:green">✅ System Ready</span>`;
                    statusDiv.style.background = "#dcfce7";
                    
                    loginBtn.disabled = false;
                    loginBtn.innerText = "LOGIN";
                    loginBtn.addEventListener('click', doLogin);
                }
            } catch(e) {
                statusDiv.innerText = "Init Error: " + e.message;
            }
        }

        // LOGIN LOGIC
        async function doLogin() {
            const uid = document.getElementById('inp-id').value.trim();
            const pwd = document.getElementById('inp-pass').value.trim();
            
            if (!uid || !pwd) { alert("Enter Credentials"); return; }
            
            loginBtn.innerText = "Checking...";
            loginBtn.disabled = true;

            try {
                // 1. Fetch User
                const { data, error } = await supabase.from('employees').select('*').eq('emp_id', uid).single();
                
                if (error || !data) throw new Error("User not found");

                // 2. Check Password
                let valid = (data.pass === pwd); // Simple check
                if (!valid && window.bcrypt) valid = bcrypt.compareSync(pwd, data.pass); // Secure check

                if (valid) {
                    currentUser = data;
                    document.getElementById('view-login').classList.add('hidden');
                    document.getElementById('view-app').classList.remove('hidden');
                    loadHistory();
                } else {
                    alert("Wrong Password");
                    resetBtn();
                }
            } catch(err) {
                alert("Login Error: " + err.message);
                resetBtn();
            }
        }

        function resetBtn() {
            loginBtn.innerText = "LOGIN";
            loginBtn.disabled = false;
        }

        // APP FUNCTIONS
        let currentUser = null;

        async function submitApp() {
            if(!confirm("Submit Order?")) return;
            try {
                const yr = "2026";
                const div = (currentUser.division || "DAR").substring(0,4).toUpperCase();
                
                // Get Count
                const { count } = await supabase.from('travel_orders').select('*', {count:'exact', head:true}).ilike('to_no', `${yr}-${div}-%`);
                const toNo = `${yr}-${div}-${String((count||0)+1).padStart(4,'0')}`;

                // Insert
                await supabase.from('travel_orders').insert([{
                    to_no: toNo, emp_id: currentUser.emp_id, emp_name: currentUser.full_name,
                    division: currentUser.division, unit: currentUser.unit, status: "PENDING_CHIEF",
                    transport: "LAND", report_to: "Official"
                }]);

                await supabase.from('itinerary').insert([{
                    to_no: toNo, travel_date: document.getElementById('app-date').value, 
                    destination: document.getElementById('app-dest').value, 
                    purpose: document.getElementById('app-purp').value
                }]);

                alert("Success! TO#: " + toNo);
                loadHistory();
            } catch(e) { alert(e.message); }
        }

        async function loadHistory() {
            const list = document.getElementById('list-history');
            list.innerHTML = "Loading...";
            const { data } = await supabase.from('travel_orders').select('*').eq('emp_id', currentUser.emp_id).order('created_at', {ascending:false}).limit(5);
            
            list.innerHTML = "";
            if(!data || data.length === 0) { list.innerHTML = "No records."; return; }

            data.forEach(x => {
                const col = x.status === 'APPROVED' ? 'green' : 'orange';
                list.innerHTML += `<div class="card p-2 mb-2"><strong>${x.to_no}</strong><span style="color:${col}">${x.status}</span></div>`;
            });
        }
    </script>
</body>
</html>
