<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAR Mobile Simple</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>

    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; padding: 20px; }
        .card { max-width: 400px; margin: 0 auto; border: none; shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-dar { background-color: #003811; color: white; font-weight: bold; }
        .hidden { display: none !important; }
        #debug-log { font-size: 10px; color: #666; margin-top: 20px; text-align: center; }
    </style>
</head>
<body>

    <div id="view-login" class="container mt-5">
        <div class="card p-4">
            <h3 class="text-center" style="color:#003811; font-weight:bold">DAR TRAVEL</h3>
            <p class="text-center text-muted small">Mobile Portal</p>
            <hr>
            
            <div class="mb-3">
                <label class="form-label small fw-bold">ID Number</label>
                <input type="text" id="inp-id" class="form-control" placeholder="Enter ID">
            </div>
            
            <div class="mb-4">
                <label class="form-label small fw-bold">Password</label>
                <input type="password" id="inp-pass" class="form-control" placeholder="••••••">
            </div>

            <button id="btn-login" class="btn btn-dar w-100 py-2">LOGIN</button>
            
            <div id="debug-log">Initializing...</div>
        </div>
    </div>

    <div id="view-app" class="hidden">
        <nav class="navbar fixed-top" style="background:#003811; color:white">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1 text-warning">DAR Mobile</span>
                <button onclick="location.reload()" class="btn btn-sm btn-outline-light">Logout</button>
            </div>
        </nav>
        <div style="margin-top: 80px" class="container">
            <h5 class="mb-3">New Application</h5>
            <div class="card p-3 mb-3">
                <label class="small text-muted">Destination</label>
                <input type="text" id="app-dest" class="form-control mb-2">
                <label class="small text-muted">Date</label>
                <input type="date" id="app-date" class="form-control mb-2">
                <label class="small text-muted">Purpose</label>
                <input type="text" id="app-purp" class="form-control mb-2">
                <button onclick="submitApp()" class="btn btn-success mt-2">Submit</button>
            </div>
            
            <h5 class="mb-3">My History</h5>
            <button onclick="loadHistory()" class="btn btn-sm btn-secondary mb-2">Refresh List</button>
            <div id="list-history">Loading...</div>
        </div>
    </div>

    <script>
        // CONFIG
        const URL = "https://ytfpiyfapvybihlngxks.supabase.co";
        const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0ZnBpeWZhcHZ5YmlobG5neGtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDA2MTIsImV4cCI6MjA4NTY3NjYxMn0.7TRVjvFjxVtxkP_hL3wnlxPT6FXJd0y7aKHNzDHThAQ";
        
        let supabase = null;
        let currentUser = null;
        const log = document.getElementById('debug-log');

        // 1. INITIALIZE ON LOAD
        window.onload = function() {
            try {
                if (window.supabase) {
                    supabase = window.supabase.createClient(URL, KEY);
                    log.innerText = "System Ready. Database Connected.";
                    log.style.color = "green";
                    
                    // Bind Click Event
                    document.getElementById('btn-login').addEventListener('click', doLogin);
                } else {
                    log.innerText = "Error: Supabase Library failed to load.";
                    log.style.color = "red";
                }
            } catch (err) {
                log.innerText = "Init Error: " + err.message;
                log.style.color = "red";
            }
        };

        // 2. LOGIN LOGIC
        async function doLogin() {
            const btn = document.getElementById('btn-login');
            const uid = document.getElementById('inp-id').value.trim();
            const pwd = document.getElementById('inp-pass').value.trim();

            if (!uid || !pwd) { alert("Please enter ID and Password"); return; }

            // Visual Feedback
            btn.innerText = "Checking...";
            btn.disabled = true;

            try {
                // A. Get User
                const { data, error } = await supabase.from('employees').select('*').eq('emp_id', uid).single();
                
                if (error || !data) {
                    throw new Error("User ID not found.");
                }

                // B. Check Password
                let valid = false;
                if (data.pass === pwd) {
                    valid = true; // Plain text match
                } else if (window.bcrypt && window.bcrypt.compareSync(pwd, data.pass)) {
                    valid = true; // Encrypted match
                }

                if (valid) {
                    currentUser = data;
                    document.getElementById('view-login').classList.add('hidden');
                    document.getElementById('view-app').classList.remove('hidden');
                    loadHistory();
                } else {
                    alert("Incorrect Password");
                    btn.innerText = "LOGIN";
                    btn.disabled = false;
                }

            } catch (err) {
                alert("Login Failed: " + err.message);
                btn.innerText = "LOGIN";
                btn.disabled = false;
            }
        }

        // 3. SUBMIT APP
        async function submitApp() {
            const dest = document.getElementById('app-dest').value;
            const date = document.getElementById('app-date').value;
            const purp = document.getElementById('app-purp').value;

            if(!dest || !date) { alert("Fill all fields"); return; }
            if(!confirm("Submit Order?")) return;

            try {
                // Generate TO Number
                const yr = "2026";
                const div = (currentUser.division || "DAR").substring(0,4).toUpperCase();
                const { count } = await supabase.from('travel_orders').select('*', {count:'exact', head:true}).ilike('to_no', `${yr}-${div}-%`);
                const toNo = `${yr}-${div}-${String((count||0)+1).padStart(4,'0')}`;

                // Insert Order
                await supabase.from('travel_orders').insert([{
                    to_no: toNo, emp_id: currentUser.emp_id, emp_name: currentUser.full_name,
                    division: currentUser.division, unit: currentUser.unit, status: "PENDING_CHIEF",
                    transport: "LAND", report_to: "Official"
                }]);

                // Insert Itinerary
                await supabase.from('itinerary').insert([{
                    to_no: toNo, travel_date: date, destination: dest, purpose: purp
                }]);

                alert("Success! TO#: " + toNo);
                loadHistory();
                // Clear inputs
                document.getElementById('app-dest').value = "";
                document.getElementById('app-purp').value = "";

            } catch(e) { alert("Error: " + e.message); }
        }

        // 4. LOAD HISTORY
        async function loadHistory() {
            const list = document.getElementById('list-history');
            list.innerHTML = "Loading...";
            
            const { data } = await supabase.from('travel_orders')
                .select('*')
                .eq('emp_id', currentUser.emp_id)
                .order('created_at', {ascending:false})
                .limit(10);
                
            list.innerHTML = "";
            if(!data || data.length === 0) { list.innerHTML = "No records found."; return; }

            data.forEach(item => {
                const color = item.status === 'APPROVED' ? 'green' : 'orange';
                list.innerHTML += `
                    <div class="card p-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <strong>${item.to_no}</strong>
                            <span style="color:${color}; font-weight:bold">${item.status}</span>
                        </div>
                    </div>`;
            });
        }
    </script>
</body>
</html>
