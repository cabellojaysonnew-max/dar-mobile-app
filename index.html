<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAR Lite</title>
    <style>
        /* CSS RESET & STYLES */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f4f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 400px; margin: 0 auto; }
        
        /* CARDS */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* TYPOGRAPHY */
        h2 { margin: 0 0 5px 0; color: #003811; font-weight: 800; letter-spacing: -0.5px; }
        .sub { color: #666; font-size: 13px; margin-bottom: 20px; display: block; }
        label { font-size: 11px; font-weight: 700; color: #888; text-transform: uppercase; display: block; margin-bottom: 5px; }
        
        /* INPUTS */
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        input:focus { outline: none; border-color: #003811; }
        
        /* BUTTONS */
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: #003811; color: white; }
        .btn-primary:active { background: #00250b; transform: scale(0.98); }
        .btn-sec { background: #eee; color: #333; margin-top: 10px; }
        
        /* UTILS */
        .hidden { display: none; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .bg-green { background: #d1fae5; color: #065f46; }
        .bg-orange { background: #ffedd5; color: #9a3412; }
        
        /* NAVIGATION */
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; text-align: center; padding: 15px 0; font-size: 11px; color: #999; cursor: pointer; }
        .nav-item.active { color: #003811; font-weight: bold; background: #f9f9f9; }
        .emoji { font-size: 18px; display: block; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div id="view-login" class="container" style="margin-top: 50px;">
        <div class="card">
            <h2 style="text-align: center;">DAR TRAVEL</h2>
            <span class="sub" style="text-align: center;">Lite Connection (No-Lib)</span>
            <hr style="border:0; border-top:1px solid #eee; margin-bottom:20px;">

            <label>Employee ID</label>
            <input type="text" id="uid" placeholder="Enter ID">

            <label>Password</label>
            <input type="password" id="pwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

            <button onclick="doLogin()" class="btn-primary" id="btn-login">SECURE LOGIN</button>
            <div id="login-msg" style="text-align:center; font-size:12px; margin-top:15px; color:#d32f2f;"></div>
        </div>
    </div>

    <div id="view-app" class="container hidden" style="padding-bottom: 80px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div>
                <h2 id="disp-name">User</h2>
                <span class="sub" id="disp-div" style="margin:0">Division</span>
            </div>
            <button onclick="location.reload()" style="width:auto; padding:8px 15px; background:#fff; border:1px solid #ddd; color:#333;">Logout</button>
        </div>

        <div id="sec-post">
            <div class="card">
                <label>Destination</label>
                <input type="text" id="p-dest">
                
                <label>Date</label>
                <input type="date" id="p-date">
                
                <label>Purpose</label>
                <input type="text" id="p-purp">
                
                <button onclick="submitOrder()" class="btn-primary">SUBMIT ORDER</button>
            </div>
        </div>

        <div id="sec-mon" class="hidden">
            <button onclick="loadHistory()" class="btn-sec" style="margin-bottom:15px;">Refresh History</button>
            <div id="hist-list"></div>
        </div>
    </div>

    <div id="navbar" class="nav hidden">
        <div class="nav-item active" onclick="nav('post', this)"><span class="emoji">‚úèÔ∏è</span>New</div>
        <div class="nav-item" onclick="nav('mon', this)"><span class="emoji">üìã</span>History</div>
    </div>

    <script>
        // CONFIGURATION
        const CONFIG = {
            url: "https://ytfpiyfapvybihlngxks.supabase.co",
            key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0ZnBpeWZhcHZ5YmlobG5neGtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDA2MTIsImV4cCI6MjA4NTY3NjYxMn0.7TRVjvFjxVtxkP_hL3wnlxPT6FXJd0y7aKHNzDHThAQ"
        };

        let user = null;

        // --- CORE: DIRECT API CALLER ---
        async function apiCall(table, params = "", method = "GET", body = null) {
            const headers = {
                "apikey": CONFIG.key,
                "Authorization": "Bearer " + CONFIG.key,
                "Content-Type": "application/json",
                "Prefer": "return=representation" // Ask Supabase to return the data after insert
            };

            const url = `${CONFIG.url}/rest/v1/${table}${params}`;
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: headers,
                    body: body ? JSON.stringify(body) : null
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                return await response.json();
            } catch (e) {
                console.error(e);
                throw e; // Pass error up
            }
        }

        // --- LOGIN LOGIC ---
        async function doLogin() {
            const uid = document.getElementById('uid').value.trim();
            const pwd = document.getElementById('pwd').value.trim();
            const btn = document.getElementById('btn-login');
            const msg = document.getElementById('login-msg');

            if (!uid || !pwd) { msg.innerText = "Please enter credentials"; return; }

            btn.innerText = "CONNECTING...";
            btn.disabled = true;
            msg.innerText = "";

            try {
                // 1. Direct Fetch User (GET /employees?emp_id=eq.X)
                const data = await apiCall('employees', `?emp_id=eq.${uid}&select=*`);

                if (!data || data.length === 0) throw new Error("User ID not found");
                
                const u = data[0];

                // 2. Password Check (Direct comparison only since no library)
                // WARNING: If your DB has hashed passwords, this strict check might fail.
                // We are checking if they match exactly.
                if (u.pass !== pwd) {
                    throw new Error("Incorrect Password (Verify Case Sensitivity)");
                }

                // Success
                user = u;
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                document.getElementById('navbar').classList.remove('hidden');

                document.getElementById('disp-name').innerText = u.full_name;
                document.getElementById('disp-div').innerText = u.division || "DAR";

            } catch (e) {
                msg.innerText = e.message;
                btn.innerText = "SECURE LOGIN";
                btn.disabled = false;
            }
        }

        // --- SUBMIT LOGIC ---
        async function submitOrder() {
            const dest = document.getElementById('p-dest').value;
            const date = document.getElementById('p-date').value;
            const purp = document.getElementById('p-purp').value;

            if(!dest || !date) { alert("Fill all fields"); return; }
            if(!confirm("Submit Order?")) return;

            const btn = document.querySelector('#sec-post button');
            btn.innerText = "SENDING...";
            btn.disabled = true;

            try {
                // 1. Generate TO No (Count existing)
                const yr = "2026";
                const div = (user.division || "DAR").substring(0,4).toUpperCase();
                // We use 'head=true' logic via count header, but simpler here: fetch recent
                const recent = await apiCall('travel_orders', `?to_no=ilike.${yr}-${div}-%&order=created_at.desc&limit=1`);
                
                let nextNum = 1;
                if(recent.length > 0) {
                    const parts = recent[0].to_no.split('-');
                    if(parts.length > 2) nextNum = parseInt(parts[2]) + 1;
                }
                const toNo = `${yr}-${div}-${String(nextNum).padStart(4,'0')}`;

                // 2. Insert Order
                let st = "PENDING_CHIEF";
                if((user.unit||"").toUpperCase() === "PARPO") st = "PENDING_PARPO";
                else if(user.unit && user.unit !== "None") st = "PENDING_UNIT_HEAD";

                await apiCall('travel_orders', '', 'POST', {
                    to_no: toNo, emp_id: user.emp_id, emp_name: user.full_name,
                    division: user.division, unit: user.unit, status: st,
                    transport: "LAND", report_to: "Official"
                });

                // 3. Insert Itinerary
                await apiCall('itinerary', '', 'POST', {
                    to_no: toNo, travel_date: date, destination: dest, purpose: purp
                });

                alert("Success! TO: " + toNo);
                // Reset
                document.getElementById('p-dest').value = "";
                btn.innerText = "SUBMIT ORDER";
                btn.disabled = false;
                nav('mon', document.querySelectorAll('.nav-item')[1]);

            } catch(e) {
                alert("Error: " + e.message);
                btn.innerText = "SUBMIT ORDER";
                btn.disabled = false;
            }
        }

        // --- HISTORY LOGIC ---
        async function loadHistory() {
            const list = document.getElementById('hist-list');
            list.innerHTML = "Loading...";

            try {
                const data = await apiCall('travel_orders', `?emp_id=eq.${user.emp_id}&order=created_at.desc&limit=10`);
                
                list.innerHTML = "";
                if(data.length === 0) { list.innerHTML = "<div style='text-align:center;color:#999;margin-top:20px;'>No records</div>"; return; }

                data.forEach(x => {
                    const badgeClass = x.status === 'APPROVED' ? 'bg-green' : 'bg-orange';
                    list.innerHTML += `
                        <div class="card" style="padding:15px; margin-bottom:10px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <strong style="font-size:14px;">${x.to_no}</strong>
                                <span class="badge ${badgeClass}">${x.status}</span>
                            </div>
                            <div style="font-size:12px; color:#666;">Transport: ${x.transport || 'N/A'}</div>
                        </div>
                    `;
                });
            } catch(e) {
                list.innerHTML = "Error loading history";
            }
        }

        // --- UI UTILS ---
        function nav(id, el) {
            document.getElementById('sec-post').classList.add('hidden');
            document.getElementById('sec-mon').classList.add('hidden');
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            
            el.classList.add('active');
            
            if(id === 'post') document.getElementById('sec-post').classList.remove('hidden');
            else {
                document.getElementById('sec-mon').classList.remove('hidden');
                loadHistory();
            }
        }
    </script>
</body>
</html>
