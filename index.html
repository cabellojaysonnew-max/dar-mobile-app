<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAR Quick Travel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f5; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input, select { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #003811; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; }
        .hidden { display: none; }
        #error-msg { color: red; font-size: 12px; margin-top: 10px; text-align: center; }
        .status-box { background: #e6fffa; color: #003811; padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center; font-size: 12px; }
    </style>
</head>
<body>

    <div id="view-login" class="container">
        <h3 style="text-align:center; color:#003811;">DAR TRAVEL</h3>
        <p style="text-align:center; font-size:12px; color:#666;">Direct Connect</p>
        
        <input type="text" id="uid" placeholder="Employee ID">
        <input type="password" id="pwd" placeholder="Password">
        
        <button onclick="login()" id="btn-login">CONNECT</button>
        <div id="error-msg"></div>
    </div>

    <div id="view-app" class="container hidden">
        <div class="status-box">
            Logged in as: <strong id="u-name">User</strong><br>
            Division: <strong id="u-div">---</strong> | Unit: <strong id="u-unit">---</strong>
        </div>

        <label style="font-size:12px; font-weight:bold;">DESTINATION</label>
        <input type="text" id="p-dest">

        <label style="font-size:12px; font-weight:bold;">DATE</label>
        <input type="date" id="p-date">

        <label style="font-size:12px; font-weight:bold;">PURPOSE</label>
        <input type="text" id="p-purp">

        <button onclick="submitOrder()" id="btn-submit">SUBMIT TRAVEL ORDER</button>
        <button onclick="location.reload()" style="background:white; color:#333; border:1px solid #ccc; margin-top:10px;">Logout</button>
    </div>

    <script>
        // CONFIG
        const DB_URL = "https://ytfpiyfapvybihlngxks.supabase.co";
        const DB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0ZnBpeWZhcHZ5YmlobG5neGtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDA2MTIsImV4cCI6MjA4NTY3NjYxMn0.7TRVjvFjxVtxkP_hL3wnlxPT6FXJd0y7aKHNzDHThAQ";
        
        let supabase = null;
        let currentUser = null;

        // INIT
        window.onload = () => {
            if(window.supabase) supabase = window.supabase.createClient(DB_URL, DB_KEY);
            else alert("Error: Library not loaded. Check internet.");
        };

        // --- 1. CONNECT & AUTH ---
        async function login() {
            const uid = document.getElementById('uid').value.trim();
            const pwd = document.getElementById('pwd').value.trim();
            const btn = document.getElementById('btn-login');
            const err = document.getElementById('error-msg');

            if(!uid || !pwd) return;

            btn.innerText = "CONNECTING...";
            btn.disabled = true;
            err.innerText = "";

            try {
                // Fetch User
                const { data, error } = await supabase.from('employees').select('*').eq('emp_id', uid).single();
                
                if(error) throw error;
                if(!data) throw new Error("User not found");

                // Check Password (Exact Match for Simplicity)
                if(data.pass !== pwd) throw new Error("Wrong Password");

                // Success
                currentUser = data;
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                
                document.getElementById('u-name').innerText = data.full_name;
                document.getElementById('u-div').innerText = data.division || "DAR";
                document.getElementById('u-unit').innerText = data.unit || "NONE";

            } catch(e) {
                console.error(e);
                if(e.message.includes("fetch")) {
                    err.innerHTML = "⚠️ <b>CONNECTION BLOCKED</b><br>You MUST add your GitHub URL to Supabase:<br>Authentication > URL Configuration";
                } else {
                    err.innerText = e.message;
                }
                btn.innerText = "CONNECT";
                btn.disabled = false;
            }
        }

        // --- 2. LOGIC: ID & STATUS ---
        async function submitOrder() {
            const dest = document.getElementById('p-dest').value;
            const date = document.getElementById('p-date').value;
            const purp = document.getElementById('p-purp').value;

            if(!dest || !date) return alert("Missing Info");

            const btn = document.getElementById('btn-submit');
            btn.innerText = "PROCESSING...";
            btn.disabled = true;

            try {
                // A. DETERMINE STATUS
                let status = "PENDING_DIVISION_CHIEF"; // Default
                const unit = (currentUser.unit || "").toUpperCase();
                
                if (unit === "PARPO") {
                    status = "PENDING_PARPO";
                } else if (unit && unit !== "NONE") {
                    status = "PENDING_UNIT_HEAD";
                }

                // B. GENERATE ID (YYYY-DIV-XXXXX)
                const yr = "2026";
                // Get first 4 letters of Division (e.g. STOD)
                const divCode = (currentUser.division || "DAR").substring(0,4).toUpperCase();
                
                // Count how many orders exist for this Division in 2026 to verify next number
                const { count } = await supabase
                    .from('travel_orders')
                    .select('*', { count: 'exact', head: true })
                    .ilike('to_no', `${yr}-${divCode}-%`);
                
                // Format: 2026-STOD-00001
                const nextNum = (count || 0) + 1;
                const toNo = `${yr}-${divCode}-${String(nextNum).padStart(5, '0')}`;

                // C. SAVE TO DATABASE
                // 1. Order Header
                const { error: e1 } = await supabase.from('travel_orders').insert({
                    to_no: toNo,
                    emp_id: currentUser.emp_id,
                    emp_name: currentUser.full_name,
                    division: currentUser.division,
                    unit: currentUser.unit,
                    status: status,
                    transport: "LAND", // Default
                    report_to: "Official" // Default
                });
                if(e1) throw e1;

                // 2. Itinerary Detail
                const { error: e2 } = await supabase.from('itinerary').insert({
                    to_no: toNo,
                    travel_date: date,
                    destination: dest,
                    purpose: purp
                });
                if(e2) throw e2;

                // D. SUCCESS
                alert(`SUCCESS!\n\nOrder #: ${toNo}\nStatus: ${status}`);
                location.reload(); // Refresh to clear

            } catch(e) {
                alert("Error: " + e.message);
                btn.innerText = "SUBMIT TRAVEL ORDER";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
