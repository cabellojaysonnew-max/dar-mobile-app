<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAR QuickSubmit</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* MINIMALIST DESIGN */
        body { font-family: -apple-system, sans-serif; background: #f8f9fa; padding: 20px; color: #2d3748; }
        .container { max-width: 400px; margin: 0 auto; }
        
        /* CARD STYLE */
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h1 { color: #003811; font-size: 20px; text-align: center; margin-bottom: 5px; }
        p.sub { text-align: center; color: #718096; font-size: 13px; margin-bottom: 25px; }

        /* INPUTS */
        label { font-size: 11px; font-weight: bold; color: #718096; display: block; margin-bottom: 4px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        input:focus { border-color: #003811; outline: none; }

        /* BUTTONS */
        button { width: 100%; padding: 14px; background: #003811; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px; }
        button:disabled { background: #cbd5e0; cursor: not-allowed; }
        button.secondary { background: white; border: 1px solid #cbd5e0; color: #4a5568; margin-top: 10px; }

        /* ERROR BOX */
        #error-box { background: #fff5f5; border: 1px solid #feb2b2; color: #c53030; padding: 15px; border-radius: 8px; font-size: 13px; margin-top: 20px; display: none; }
        .fix-link { color: #c53030; text-decoration: underline; font-weight: bold; }

        /* UTILS */
        .hidden { display: none; }
        .success { color: #003811; text-align: center; font-weight: bold; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="view-login" class="card">
            <h1>DAR TRAVEL</h1>
            <p class="sub">Quick Access Portal</p>

            <label>Employee ID</label>
            <input type="text" id="uid" placeholder="e.g. 503250005" pattern="\d*">

            <button onclick="checkID()" id="btn-check">ENTER SYSTEM</button>

            <div id="error-box">
                <strong>Connection Failed.</strong><br>
                Your database is blocking this website.<br><br>
                1. Go to Supabase Dashboard<br>
                2. Click <strong>Authentication</strong> (Lock Icon) on left sidebar<br>
                3. Click <strong>URL Configuration</strong><br>
                4. Add this link to "Redirect URLs":<br>
                <code style="background:#eee; padding:2px;">https://cabellojaysonnew-max.github.io</code>
            </div>
        </div>

        <div id="view-app" class="card hidden">
            <div class="success">Welcome, <span id="u-name">User</span></div>
            
            <label>Destination</label>
            <input type="text" id="p-dest">

            <label>Date</label>
            <input type="date" id="p-date">

            <label>Purpose</label>
            <input type="text" id="p-purp">

            <button onclick="submitOrder()" id="btn-submit">SUBMIT ORDER</button>
            <button class="secondary" onclick="location.reload()">Logout</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const DB_URL = "https://ytfpiyfapvybihlngxks.supabase.co";
        const DB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0ZnBpeWZhcHZ5YmlobG5neGtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDA2MTIsImV4cCI6MjA4NTY3NjYxMn0.7TRVjvFjxVtxkP_hL3wnlxPT6FXJd0y7aKHNzDHThAQ";
        
        // Initialize Supabase Client
        let supabase = null;
        let currentUser = null;

        window.onload = function() {
            if(window.supabase) {
                supabase = window.supabase.createClient(DB_URL, DB_KEY);
            } else {
                alert("Critical Error: Supabase library failed to load.");
            }
        };

        // --- 1. SIMPLE LOGIN (ID CHECK) ---
        async function checkID() {
            const uid = document.getElementById('uid').value.trim();
            const btn = document.getElementById('btn-check');
            const errBox = document.getElementById('error-box');

            if (!uid) return alert("Please enter Employee ID");

            btn.innerText = "CHECKING...";
            btn.disabled = true;
            errBox.style.display = 'none';

            try {
                // Try to get user. If this fails, it's a connection/CORS issue.
                const { data, error } = await supabase
                    .from('employees')
                    .select('*')
                    .eq('emp_id', uid)
                    .single();

                if (error) throw error;
                if (!data) throw new Error("ID not found in database.");

                // Success
                currentUser = data;
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                document.getElementById('u-name').innerText = data.full_name.split(" ")[0]; // First name only

            } catch (error) {
                console.error(error);
                // IF ERROR IS "Failed to fetch", SHOW THE INSTRUCTION BOX
                if (error.message.includes("fetch") || error.message.includes("Network")) {
                    errBox.style.display = 'block';
                } else {
                    alert("Error: " + error.message);
                }
                btn.innerText = "ENTER SYSTEM";
                btn.disabled = false;
            }
        }

        // --- 2. SIMPLE SUBMIT ---
        async function submitOrder() {
            const dest = document.getElementById('p-dest').value;
            const date = document.getElementById('p-date').value;
            const purp = document.getElementById('p-purp').value;

            if (!dest || !date) return alert("Fill Destination and Date");

            const btn = document.getElementById('btn-submit');
            btn.innerText = "SENDING...";
            btn.disabled = true;

            try {
                // 1. Generate TO Number
                const yr = "2026";
                const div = (currentUser.division || "DAR").substring(0,4).toUpperCase();
                
                // Get count for ID
                const { count } = await supabase
                    .from('travel_orders')
                    .select('*', { count: 'exact', head: true })
                    .ilike('to_no', `${yr}-${div}-%`);
                
                const nextNum = (count || 0) + 1;
                const toNo = `${yr}-${div}-${String(nextNum).padStart(4,'0')}`;

                // 2. Insert Header
                const { error: err1 } = await supabase.from('travel_orders').insert({
                    to_no: toNo,
                    emp_id: currentUser.emp_id,
                    emp_name: currentUser.full_name,
                    division: currentUser.division,
                    unit: currentUser.unit,
                    status: "PENDING_CHIEF", // Default status
                    transport: "LAND",
                    report_to: "Official"
                });
                if(err1) throw err1;

                // 3. Insert Itinerary
                const { error: err2 } = await supabase.from('itinerary').insert({
                    to_no: toNo,
                    travel_date: date,
                    destination: dest,
                    purpose: purp
                });
                if(err2) throw err2;

                alert("Success! TO # " + toNo);
                
                // Reset Fields
                document.getElementById('p-dest').value = "";
                document.getElementById('p-purp').value = "";
                
            } catch (error) {
                alert("Submission Failed: " + error.message);
            }
            btn.innerText = "SUBMIT ORDER";
            btn.disabled = false;
        }
    </script>
</body>
</html>
